"""Simple python program making an API call to Microsoft Graphs to fetch a map of CVEs and KBs"""

from oauthlib.oauth2 import BackendApplicationClient
from requests_oauthlib import OAuth2Session

import apiconfig

import mysql.connector

def getCVE_KB():
	client = BackendApplicationClient(client_id = apiconfig.CLIENT_ID)

	oauth = OAuth2Session(client=client)

	token = oauth.fetch_token(token_url = apiconfig.AUTHORITY_URL + apiconfig.TOKEN_ENDPOINT,
		client_id = apiconfig.CLIENT_ID,
		client_secret = apiconfig.CLIENT_SECRET,
		scope = apiconfig.SCOPE)

	endpoint = apiconfig.RESOURCE + apiconfig.RESOURCE_ENDPOINT
	headers = {'Content-type': 'application/json',
		   'Bearer': token['access_token']}

	graphdata = oauth.get(endpoint, headers=headers).json()
	
	return graphdata

#print(graphdata['value'][0])

def connect_db(dbHost, dbUser, dbPass, dbName):

	db = mysql.connector.connect(
	  host = dbHost,
	  user = dbUser,
	  passwd = dbPass,
	  database = dbName
	)
	return db
	
def createTable_db(dbName):
	
	db = connect_db(apiconfig.dbHost,
			apiconfig.dbUser,
			apiconfig.dbPass,
			apiconfig.dbName
			)

	cursor = db.cursor()
	
	create_dbQuery = "CREATE DATABASE " + dbName
	cursor.execute(create_dbQuery)
	
	use_dbQuery = "USE " + dbName
	cursor.execute(use_dbQuery)
	
	createTable_dbQuery = "CREATE TABLE CVE_KB ()"
	
def insert_db(dbname): <<<<<<<<<<<<<<<<
	
	db = connect_db(apiconfig.dbHost,
			apiconfig.dbUser,
			apiconfig.dbPass,
			dbName
			)

	cursor = db.cursor()
	
	insert_dbQuery = "INSERT INTO  " + dbName
	cursor.execute(insert_dbQuery)


#create_db('hkloollololol')
